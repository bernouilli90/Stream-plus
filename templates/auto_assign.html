{% extends "base.html" %}

{% block title %}Auto-Assignment - Stream Plus{% endblock %}

{% block extra_css %}
<style>
    #channelDropdown {
        position: absolute;
        z-index: 1050;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    #channelDropdown .dropdown-item {
        padding: 0.5rem 1rem;
        transition: background-color 0.15s ease-in-out;
    }
    
    #channelDropdown .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    #channelSearch {
        position: relative;
    }
    
    .rule-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .rule-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .badge {
        font-weight: 500;
    }
    
    .dropdown-menu {
        min-width: 140px;
    }
    
    .rule-card .dropdown {
        position: static;
    }
    
    .rule-card .dropdown-menu {
        z-index: 1080;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        position: absolute;
        transform: translate3d(0, 0, 1px);
    }
    
    .rule-card .dropdown-menu.show {
        transform: translate3d(0, 0, 1px);
    }
</style>
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-magic text-primary"></i> Stream Auto-Assignment
    </h1>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="showBulkCreateModal()">
            <i class="fas fa-layer-group"></i> Bulk Create Rules
        </button>
        <button class="btn btn-primary" onclick="showCreateRuleModal()">
            <i class="fas fa-plus"></i> New Rule
        </button>
    </div>
</div>

<!-- Description -->
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i>
    <strong>Automatically assign streams to channels</strong> based on configurable conditions like name (regex), M3U source, bitrate, codecs, resolution, and FPS.
</div>

<!-- Channel Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="channelFilter" placeholder="Filter by channel name...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearChannelFilter()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <small class="text-muted" id="rulesCount">
            {% if rules %}Showing {{ rules|length }} rule{{ 's' if rules|length != 1 else '' }}{% else %}No rules{% endif %}
        </small>
    </div>
</div>

<!-- Rule list -->
<div id="rulesContainer">
    {% if rules %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="rulesList">
            {% for rule in rules %}
            <div class="col rule-card" data-channel-name="{% set channel = channels.get(rule.channel_id) %}{{ channel.name|lower if channel else '' }}">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                        <div class="d-flex align-items-center flex-grow-1">
                            <div class="form-check form-switch me-2">
                                <input class="form-check-input" type="checkbox" id="enableRule{{ rule.id }}" 
                                       {% if rule.enabled %}checked{% endif %} 
                                       onchange="toggleRule({{ rule.id }})"
                                       style="cursor: pointer; transform: scale(0.8);">
                            </div>
                            {% set channel = channels.get(rule.channel_id) %}
                            {% if channel %}
                                {% if channel.logo %}
                                <img src="{{ channel.logo }}" alt="{{ channel.name }}" class="rounded me-2" style="height: 24px; width: 24px; object-fit: contain;">
                                {% else %}
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-2" style="height: 24px; width: 24px;">
                                    <i class="fas fa-tv text-white" style="font-size: 12px;"></i>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-2" style="height: 24px; width: 24px;">
                                    <i class="fas fa-tv text-white" style="font-size: 12px;"></i>
                                </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <h6 class="mb-0 text-truncate" style="font-size: 0.9rem;">
                                    {{ rule.name }}
                                </h6>
                                <small class="text-muted">
                                    {% if channel %}
                                        {{ channel.name }}
                                    {% else %}
                                        Channel #{{ rule.channel_id }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end dropup">
                                <li><a class="dropdown-item" href="#" onclick="previewRule({{ rule.id }})"><i class="fas fa-eye me-2"></i>Preview</a></li>
                                <li><a class="dropdown-item" href="#" onclick="executeRule({{ rule.id }})" {% if not rule.enabled %}class="disabled"{% endif %}><i class="fas fa-play me-2"></i>Execute</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="editRule({{ rule.id }})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteRule({{ rule.id }})"><i class="fas fa-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row g-2">
                            <div class="col-12">
                                {% if rule.regex_pattern %}
                                <small class="text-muted d-block mb-1">
                                    <i class="fas fa-search me-1"></i>
                                    <code style="font-size: 0.75rem;">{{ rule.regex_pattern }}</code>
                                </small>
                                {% endif %}
                                
                                <div class="d-flex flex-wrap gap-1 mb-1">
                                    {% if rule.replace_existing_streams %}
                                    <span class="badge bg-warning" style="font-size: 0.7rem;">Replace existing</span>
                                    {% endif %}
                                    {% if rule.test_streams_before_sorting %}
                                    <span class="badge bg-info" style="font-size: 0.7rem;">Test streams</span>
                                    {% endif %}
                                    {% if not rule.enabled %}
                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">Disabled</span>
                                    {% else %}
                                    <span class="badge bg-success" style="font-size: 0.7rem;">Enabled</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if rule.video_bitrate_operator and rule.video_bitrate_value %}
                            <div class="col-auto">
                                <small class="text-muted">
                                    <i class="fas fa-tachometer-alt me-1"></i>{{ rule.video_bitrate_operator }} {{ rule.video_bitrate_value }}k
                                </small>
                            </div>
                            {% endif %}
                            
                            {% if rule.video_resolution %}
                            <div class="col-auto">
                                <small class="text-muted">
                                    <i class="fas fa-desktop me-1"></i>
                                    {% if rule.video_resolution is iterable and rule.video_resolution is not string %}
                                        {{ rule.video_resolution|join(', ') }}
                                    {% else %}
                                        {{ rule.video_resolution }}
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                            
                            {% if rule.video_codec %}
                            <div class="col-auto">
                                <small class="text-muted">
                                    <i class="fas fa-video me-1"></i>
                                    {% if rule.video_codec is iterable and rule.video_codec is not string %}
                                        {{ rule.video_codec|join(', ') }}
                                    {% else %}
                                        {{ rule.video_codec }}
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>No auto-assignment rules</h4>
            <p>Create a new rule to start automatically assigning streams to channels.</p>
        </div>
    {% endif %}
</div>

<!-- Modal for creating/editing rule -->
<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalTitle">New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleId">
                    
                    <!-- Name and Channel -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ruleName" class="form-label">Rule Name *</label>
                            <input type="text" class="form-control" id="ruleName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="channelSearch" class="form-label">Channel *</label>
                            <input type="text" class="form-control" id="channelSearch" 
                                   placeholder="Search channel by name or ID..." 
                                   autocomplete="off" required>
                            <input type="hidden" id="channelId" required>
                            <div id="channelDropdown" class="dropdown-menu" style="max-height: 300px; overflow-y: auto; width: 100%;">
                                <!-- Channels will be loaded dynamically -->
                            </div>
                            <small class="form-text text-muted">Type to search or click to see all</small>
                        </div>
                    </div>

                    <!-- Status and Replace -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                                <label class="form-check-label" for="ruleEnabled">
                                    Rule enabled
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="replaceExisting">
                                <label class="form-check-label" for="replaceExisting">
                                    Replace existing streams
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Test Streams Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="testStreamsBeforeSorting">
                            <label class="form-check-label" for="testStreamsBeforeSorting">
                                <i class="fas fa-flask"></i> Test streams before assigning (obtains stats via ffmpeg)
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Only tests streams without stats or with outdated stats. Each stream will be started for 10 seconds to obtain stats (bitrate, codec, resolution, etc.).
                        </small>
                        
                        <!-- Force Retest All Streams Sub-option -->
                        <div class="mt-2 ms-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="forceRetestOldStreams" disabled>
                                <label class="form-check-label" for="forceRetestOldStreams">
                                    <i class="fas fa-redo"></i> Force retest of ALL streams (even with recent stats)
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-exclamation-triangle text-warning"></i> <strong>Warning:</strong> This will test ALL streams, even those with recent stats. Only use if you need to refresh all statistics.
                            </small>
                            <div class="mt-2" id="retestThresholdContainer">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> By default, only streams without stats or with stats older than 
                                    <input type="number" id="retestDaysThreshold" class="form-control form-control-sm d-inline-block" 
                                           style="width: 60px;" min="1" value="7" disabled>
                                    days will be tested.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <h6 class="border-bottom pb-2 mb-3">Search Filters</h6>

                    <!-- Regex Pattern -->
                    <div class="mb-3">
                        <label for="regexPattern" class="form-label">
                            Regex Pattern (stream name)
                            <small class="text-muted">Example: ^ESPN.*HD$</small>
                        </label>
                        <input type="text" class="form-control" id="regexPattern" placeholder="Regex pattern...">
                    </div>

                    <!-- M3U Account -->
                    <div class="mb-3">
                        <label for="m3uAccountIds" class="form-label">M3U Accounts</label>
                        <select class="form-select" id="m3uAccountIds" multiple size="3">
                            <option value="">All accounts...</option>
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple accounts. Leave empty for all accounts.</div>
                    </div>

                    <!-- Video Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Video Conditions</h6>

                    <!-- Bitrate -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bitrateOperator" class="form-label">Bitrate Operator</label>
                            <select class="form-select" id="bitrateOperator">
                                <option value="">No restriction...</option>
                                <option value=">">Greater than (>)</option>
                                <option value=">=">Greater or equal (>=)</option>
                                <option value="<">Less than (<)</option>
                                <option value="<=">Less or equal (<=)</option>
                                <option value="==">Equal (==)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bitrateValue" class="form-label">Bitrate Value (Kbps)</label>
                            <input type="number" class="form-control" id="bitrateValue" placeholder="Ex: 5000">
                        </div>
                    </div>

                    <!-- Video Codec -->
                    <div class="mb-3">
                        <label for="videoCodec" class="form-label">
                            Video Codec 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="videoCodec" multiple size="6">
                            <option value="h264">H.264</option>
                            <option value="h265">H.265 (HEVC)</option>
                            <option value="mpeg2">MPEG-2</option>
                            <option value="vp9">VP9</option>
                            <option value="av1">AV1</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Resolution -->
                    <div class="mb-3">
                        <label for="resolution" class="form-label">
                            Video Resolution 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="resolution" multiple size="4">
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                            <option value="2160p">2160p (4K)</option>
                            <option value="SD">SD (&lt; 720p)</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- FPS -->
                    <div class="mb-3">
                        <label for="videoFps" class="form-label">
                            FPS (Frames per second) 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="videoFps" multiple size="5">
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Audio Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Audio Conditions</h6>

                    <!-- Audio Codec -->
                    <div class="mb-3">
                        <label for="audioCodec" class="form-label">
                            Audio Codec 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="audioCodec" multiple size="5">
                            <option value="aac">AAC</option>
                            <option value="ac3">AC3 (Dolby Digital)</option>
                            <option value="eac3">E-AC3 (Dolby Digital Plus)</option>
                            <option value="mp3">MP3</option>
                            <option value="opus">Opus</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="previewRuleFromForm()">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for bulk creating rules -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Create Auto-Assignment Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Bulk Rule Creation:</strong> Create auto-assignment rules automatically for all channels in a group.
                    Each rule will be generated with a regex pattern that matches streams containing all words from the channel name.
                </div>

                <form id="bulkCreateForm">
                    <!-- Group Selection -->
                    <div class="mb-3">
                        <label for="bulkGroupId" class="form-label">Channel Group *</label>
                        <select class="form-select" id="bulkGroupId" required>
                            <option value="">Select a group...</option>
                            <!-- Groups will be loaded dynamically -->
                        </select>
                        <small class="form-text text-muted">Select the channel group for which to create rules</small>
                    </div>

                    <!-- Creation Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bulkSkipExisting" checked>
                            <label class="form-check-label" for="bulkSkipExisting">
                                <i class="fas fa-filter"></i> Only create rules for channels without existing rules
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            If checked, only channels that don't have auto-assignment rules will get new rules.
                            If unchecked, existing rules will be updated with the new conditions.
                        </small>
                    </div>

                    <!-- Status and Replace -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="bulkEnabled" checked>
                                <label class="form-check-label" for="bulkEnabled">
                                    Rules enabled by default
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="bulkReplaceExisting">
                                <label class="form-check-label" for="bulkReplaceExisting">
                                    Replace existing streams
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Test Streams Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bulkTestStreamsBeforeSorting">
                            <label class="form-check-label" for="bulkTestStreamsBeforeSorting">
                                <i class="fas fa-flask"></i> Test streams before assigning (obtains stats via ffmpeg)
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Only tests streams without stats or with outdated stats. Each stream will be started for 10 seconds to obtain stats (bitrate, codec, resolution, etc.).
                        </small>

                        <!-- Force Retest All Streams Sub-option -->
                        <div class="mt-2 ms-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bulkForceRetestOldStreams" disabled>
                                <label class="form-check-label" for="bulkForceRetestOldStreams">
                                    <i class="fas fa-redo"></i> Force retest of ALL streams (even with recent stats)
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-exclamation-triangle text-warning"></i> <strong>Warning:</strong> This will test ALL streams, even those with recent stats. Only use if you need to refresh all statistics.
                            </small>
                            <div class="mt-2" id="bulkRetestThresholdContainer">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> By default, only streams without stats or with stats older than
                                    <input type="number" id="bulkRetestDaysThreshold" class="form-control form-control-sm d-inline-block"
                                           style="width: 60px;" min="1" value="7" disabled>
                                    days will be tested.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <h6 class="border-bottom pb-2 mb-3">Search Filters</h6>

                    <!-- M3U Account -->
                    <div class="mb-3">
                        <label for="bulkM3uAccountIds" class="form-label">M3U Accounts</label>
                        <select class="form-select" id="bulkM3uAccountIds" multiple size="3">
                            <option value="">All accounts...</option>
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple accounts. Leave empty for all accounts.</div>
                    </div>

                    <!-- Video Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Video Conditions</h6>

                    <!-- Bitrate -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulkBitrateOperator" class="form-label">Bitrate Operator</label>
                            <select class="form-select" id="bulkBitrateOperator">
                                <option value="">No restriction...</option>
                                <option value=">">Greater than (>)</option>
                                <option value=">=">Greater or equal (>=)</option>
                                <option value="<">Less than (<)</option>
                                <option value="<=">Less or equal (<=)</option>
                                <option value="==">Equal (==)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulkBitrateValue" class="form-label">Bitrate Value (Kbps)</label>
                            <input type="number" class="form-control" id="bulkBitrateValue" placeholder="Ex: 5000">
                        </div>
                    </div>

                    <!-- Video Codec -->
                    <div class="mb-3">
                        <label for="bulkVideoCodec" class="form-label">
                            Video Codec
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkVideoCodec" multiple size="6">
                            <option value="h264">H.264</option>
                            <option value="h265">H.265 (HEVC)</option>
                            <option value="mpeg2">MPEG-2</option>
                            <option value="vp9">VP9</option>
                            <option value="av1">AV1</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Resolution -->
                    <div class="mb-3">
                        <label for="bulkResolution" class="form-label">
                            Video Resolution
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkResolution" multiple size="4">
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                            <option value="2160p">2160p (4K)</option>
                            <option value="SD">SD (&lt; 720p)</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- FPS -->
                    <div class="mb-3">
                        <label for="bulkVideoFps" class="form-label">
                            FPS (Frames per second)
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkVideoFps" multiple size="5">
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Audio Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Audio Conditions</h6>

                    <!-- Audio Codec -->
                    <div class="mb-3">
                        <label for="bulkAudioCodec" class="form-label">
                            Audio Codec
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkAudioCodec" multiple size="5">
                            <option value="aac">AAC</option>
                            <option value="ac3">AC3 (Dolby Digital)</option>
                            <option value="eac3">E-AC3 (Dolby Digital Plus)</option>
                            <option value="mp3">MP3</option>
                            <option value="opus">Opus</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createBulkRules()">
                    <i class="fas fa-magic"></i> Create Rules
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Matches Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Progress Modal -->
<div class="modal fade" id="executionProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> Executing Auto-Assignment Rule
                </h5>
            </div>
            <div class="modal-body">
                <!-- Progress bar -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted" id="progressLabel">Initializing...</span>
                        <span class="small text-muted" id="progressPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="executionProgressBar"
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- Log output -->
                <div class="card bg-dark text-light">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-terminal"></i> Execution Log</span>
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="clearExecutionLog()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    <div class="card-body p-2" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                        <div id="executionLog"></div>
                    </div>
                </div>

                <!-- Summary (shown on completion) -->
                <div id="executionSummary" class="mt-3" style="display: none;">
                    <div class="alert" id="executionResult"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeProgressBtn" data-bs-dismiss="modal" disabled>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading indicator -->
<div id="loading" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

{% block extra_js %}
<script>
// Channel filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const channelFilter = document.getElementById('channelFilter');
    const rulesCount = document.getElementById('rulesCount');
    const ruleCards = document.querySelectorAll('.rule-card');
    const totalRules = ruleCards.length;
    
    function updateRulesCount(visibleCount) {
        if (rulesCount) {
            rulesCount.textContent = `Showing ${visibleCount} of ${totalRules} rule${totalRules !== 1 ? 's' : ''}`;
        }
    }
    
    function filterRules() {
        const filterValue = channelFilter.value.toLowerCase().trim();
        let visibleCount = 0;
        
        ruleCards.forEach(card => {
            const channelName = card.dataset.channelName || '';
            const ruleName = card.querySelector('h6').textContent.toLowerCase();
            const isVisible = !filterValue || 
                            channelName.includes(filterValue) || 
                            ruleName.includes(filterValue);
            
            card.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        updateRulesCount(visibleCount);
    }
    
    // Initial count
    updateRulesCount(totalRules);
    
    // Filter on input
    channelFilter.addEventListener('input', filterRules);
    
    // Clear filter function
    window.clearChannelFilter = function() {
        channelFilter.value = '';
        filterRules();
        channelFilter.focus();
    };
});
</script>
{% endblock %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/auto_assign_progress.js') }}"></script>
<script src="{{ url_for('static', filename='js/auto_assign.js') }}"></script>
{% endblock %}
