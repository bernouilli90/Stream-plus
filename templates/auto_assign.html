{% extends "base.html" %}

{% block title %}Auto-Assignment - Stream Plus{% endblock %}

{% block extra_css %}
<style>
    #channelDropdown {
        position: absolute;
        z-index: 1050;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    #channelDropdown .dropdown-item {
        padding: 0.5rem 1rem;
        transition: background-color 0.15s ease-in-out;
    }

    #channelDropdown .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    #channelSearch {
        position: relative;
    }

    .rule-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 16px;
        overflow: hidden;
        border: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .rule-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .rule-card .card {
        border-radius: 16px;
        border: none;
        height: 100%;
    }

    .rule-card .card-header {
        border-radius: 16px 16px 0 0 !important;
        position: relative;
        overflow: hidden;
    }

    .rule-card .card-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }

    .rule-card .card-body {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 0 0 16px 16px;
        position: relative;
    }

    .rule-card.disabled {
        opacity: 0.7;
        filter: grayscale(0.3);
    }

    .rule-card.disabled:hover {
        transform: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .badge {
        font-weight: 500;
        border-radius: 6px;
    }

    .action-buttons {
        display: flex;
        gap: 6px;
    }

    .action-btn {
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 28px;
        height: 28px;
        border: 1px solid transparent;
    }

    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    .action-btn:disabled:hover {
        box-shadow: none;
        transform: none !important;
    }

    .rule-info {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 12px;
    }

    .rule-info-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .rule-info-item i {
        margin-right: 4px;
        width: 14px;
    }

    .switch-container {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .switch-container .form-check-input {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-magic text-primary"></i> Stream Auto-Assignment
    </h1>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="showBulkCreateModal()">
            <i class="fas fa-layer-group"></i> Bulk Create Rules
        </button>
        <button class="btn btn-primary" onclick="showCreateRuleModal()">
            <i class="fas fa-plus"></i> New Rule
        </button>
    </div>
</div>

<!-- Description -->
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i>
    <strong>Automatically assign streams to channels</strong> based on configurable conditions like name (regex), M3U source, bitrate, codecs, resolution, and FPS.
</div>

<!-- Channel Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="channelFilter" placeholder="Filter by channel name...">
            <button class="btn btn-outline-secondary" type="button" onclick="clearChannelFilter()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="col-md-6 text-end">
        <small class="text-muted" id="rulesCount">
            {% if rules %}Showing {{ rules|length }} rule{{ 's' if rules|length != 1 else '' }}{% else %}No rules{% endif %}
        </small>
    </div>
</div>

<!-- Rule list -->
<div id="rulesContainer">
    {% if rules %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="rulesList">
            {% for rule in rules %}
            <div class="col rule-card {% if not rule.enabled %}disabled{% endif %}" data-channel-name="{% set channel = channels.get(rule.channel_id) %}{{ channel.name|lower if channel else '' }}">
                <div class="card h-100 shadow-sm"{% if not rule.enabled %} style="opacity: 0.6;"{% endif %}>
                    <div class="card-header d-flex align-items-start"{% if not rule.enabled %} style="background: linear-gradient(135deg, #495057 0%, #343a40 100%) !important; color: white !important; border-bottom: none !important; padding: 16px !important;"{% else %} style="background: linear-gradient(135deg, #4c63d2 0%, #6b46c1 100%) !important; color: white !important; border-bottom: none !important; padding: 16px !important;"{% endif %}>
                        <div class="d-flex align-items-start w-100">
                            <!-- Logo and Channel Info Section -->
                            <div class="d-flex align-items-center flex-grow-1 me-3">
                                {% set channel = channels.get(rule.channel_id) %}
                                {% if channel %}
                                    {% set logo = logos.get(channel.logo_id) if channel.logo_id else None %}
                                    {% if logo and (logo.cache_url or logo.url) %}
                                    <img src="{{ logo.cache_url or logo.url }}" alt="{{ channel.name }}" class="rounded me-3 shadow-sm" style="height: 48px; width: 48px; object-fit: contain; border: 2px solid rgba(255,255,255,0.4);">
                                    {% else %}
                                    <div class="bg-white bg-opacity-25 rounded d-flex align-items-center justify-content-center me-3 shadow-sm" style="height: 48px; width: 48px; border: 2px solid rgba(255,255,255,0.4);">
                                        <i class="fas fa-tv text-white" style="font-size: 20px;"></i>
                                    </div>
                                    {% endif %}
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-white mb-1" style="font-size: 1.1rem;">{{ channel.name }}</div>
                                        <div class="d-flex align-items-center">
                                            <small class="text-white-50 me-2">ID: {{ channel.id }}</small>
                                            {% if rule.enabled %}
                                            <span class="badge bg-success bg-opacity-25 text-white border border-white border-opacity-25" style="font-size: 0.65rem;">Active</span>
                                            {% else %}
                                            <span class="badge bg-secondary bg-opacity-25 text-white border border-white border-opacity-25" style="font-size: 0.65rem;">Disabled</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="bg-white bg-opacity-25 rounded d-flex align-items-center justify-content-center me-3 shadow-sm" style="height: 48px; width: 48px; border: 2px solid rgba(255,255,255,0.4);">
                                        <i class="fas fa-tv text-white" style="font-size: 20px;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-white mb-1" style="font-size: 1.1rem;">Channel #{{ rule.channel_id }}</div>
                                        <div class="d-flex align-items-center">
                                            <small class="text-white-50 me-2">ID: {{ rule.channel_id }}</small>
                                            {% if rule.enabled %}
                                            <span class="badge bg-success bg-opacity-25 text-white border border-white border-opacity-25" style="font-size: 0.65rem;">Active</span>
                                            {% else %}
                                            <span class="badge bg-secondary bg-opacity-25 text-white border border-white border-opacity-25" style="font-size: 0.65rem;">Disabled</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Controls Section -->
                            <div class="d-flex flex-column align-items-end">
                                <!-- Enable/Disable Switch -->
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="enableRule{{ rule.id }}"
                                           {% if rule.enabled %}checked{% endif %}
                                           onchange="toggleRule({{ rule.id }})"
                                           style="cursor: pointer; transform: scale(1.1);">
                                    <label class="form-check-label text-white fw-semibold" for="enableRule{{ rule.id }}" style="font-size: 0.9rem;">
                                        {{ rule.name }}
                                    </label>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex gap-1">
                                    <button class="btn btn-info btn-sm action-btn" onclick="previewRule({{ rule.id }})" title="Preview rule">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm action-btn" onclick="executeRule({{ rule.id }})"
                                            {% if not rule.enabled %}disabled{% endif %} title="Execute rule">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm action-btn" onclick="editRule({{ rule.id }})" title="Edit rule">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm action-btn" onclick="deleteRule({{ rule.id }})" title="Delete rule">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 16px;">
                        <!-- Rule Pattern -->
                        {% if rule.regex_pattern %}
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-search text-muted me-2" style="font-size: 0.8rem;"></i>
                                <small class="text-muted fw-semibold" style="font-size: 0.8rem;">PATTERN</small>
                            </div>
                            <div class="bg-light rounded p-2">
                                <code class="text-dark" style="font-size: 0.75rem; word-break: break-all;">{{ rule.regex_pattern }}</code>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Rule Conditions -->
                        {% if rule.video_bitrate_operator or rule.video_resolution or rule.video_codec or rule.audio_codec or rule.video_fps %}
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-filter text-muted me-2" style="font-size: 0.8rem;"></i>
                                <small class="text-muted fw-semibold" style="font-size: 0.8rem;">CONDITIONS</small>
                            </div>
                            <div class="row g-2">
                                {% if rule.video_bitrate_operator and rule.video_bitrate_value %}
                                <div class="col-6">
                                    <div class="d-flex align-items-center p-2 bg-light rounded" style="font-size: 0.75rem;">
                                        <i class="fas fa-tachometer-alt text-primary me-2"></i>
                                        <span class="text-dark fw-semibold">{{ rule.video_bitrate_operator }} {{ rule.video_bitrate_value }}k</span>
                                    </div>
                                </div>
                                {% endif %}

                                {% if rule.video_resolution %}
                                <div class="col-6">
                                    <div class="d-flex align-items-center p-2 bg-light rounded" style="font-size: 0.75rem;">
                                        <i class="fas fa-desktop text-success me-2"></i>
                                        <span class="text-dark fw-semibold">
                                            {% if rule.video_resolution is iterable and rule.video_resolution is not string %}
                                                {{ rule.video_resolution|join(', ') }}
                                            {% else %}
                                                {{ rule.video_resolution }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% endif %}

                                {% if rule.video_codec %}
                                <div class="col-6">
                                    <div class="d-flex align-items-center p-2 bg-light rounded" style="font-size: 0.75rem;">
                                        <i class="fas fa-video text-info me-2"></i>
                                        <span class="text-dark fw-semibold">
                                            {% if rule.video_codec is iterable and rule.video_codec is not string %}
                                                {{ rule.video_codec|join(', ') }}
                                            {% else %}
                                                {{ rule.video_codec }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% endif %}

                                {% if rule.audio_codec %}
                                <div class="col-6">
                                    <div class="d-flex align-items-center p-2 bg-light rounded" style="font-size: 0.75rem;">
                                        <i class="fas fa-volume-up text-warning me-2"></i>
                                        <span class="text-dark fw-semibold">
                                            {% if rule.audio_codec is iterable and rule.audio_codec is not string %}
                                                {{ rule.audio_codec|join(', ') }}
                                            {% else %}
                                                {{ rule.audio_codec }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                {% endif %}

                                {% if rule.video_fps %}
                                <div class="col-6">
                                    <div class="d-flex align-items-center p-2 bg-light rounded" style="font-size: 0.75rem;">
                                        <i class="fas fa-film text-danger me-2"></i>
                                        <span class="text-dark fw-semibold">{{ rule.video_fps }} FPS</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Status Badges -->
                        <div class="d-flex flex-wrap gap-1">
                            {% if rule.replace_existing_streams %}
                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                <i class="fas fa-exchange-alt me-1"></i>Replace
                            </span>
                            {% endif %}
                            {% if rule.test_streams_before_sorting %}
                            <span class="badge bg-info text-white" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                <i class="fas fa-vial me-1"></i>Test
                            </span>
                            {% endif %}
                            {% if rule.force_retest_old_streams %}
                            <span class="badge bg-primary text-white" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                                <i class="fas fa-redo me-1"></i>Retest
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h4>No auto-assignment rules</h4>
            <p>Create a new rule to start automatically assigning streams to channels.</p>
        </div>
    {% endif %}
</div>

<!-- Modal for creating/editing rule -->
<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruleModalTitle">New Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="ruleForm">
                    <input type="hidden" id="ruleId">
                    
                    <!-- Name and Channel -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ruleName" class="form-label">Rule Name *</label>
                            <input type="text" class="form-control" id="ruleName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="channelSearch" class="form-label">Channel *</label>
                            <input type="text" class="form-control" id="channelSearch" 
                                   placeholder="Search channel by name or ID..." 
                                   autocomplete="off" required>
                            <input type="hidden" id="channelId" required>
                            <div id="channelDropdown" class="dropdown-menu" style="max-height: 300px; overflow-y: auto; width: 100%;">
                                <!-- Channels will be loaded dynamically -->
                            </div>
                            <small class="form-text text-muted">Type to search or click to see all</small>
                        </div>
                    </div>

                    <!-- Status and Replace -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                                <label class="form-check-label" for="ruleEnabled">
                                    Rule enabled
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="replaceExisting">
                                <label class="form-check-label" for="replaceExisting">
                                    Replace existing streams
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Test Streams Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="testStreamsBeforeSorting">
                            <label class="form-check-label" for="testStreamsBeforeSorting">
                                <i class="fas fa-flask"></i> Test streams before assigning (obtains stats via ffmpeg)
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Only tests streams without stats or with outdated stats. Each stream will be started for 10 seconds to obtain stats (bitrate, codec, resolution, etc.).
                        </small>
                        
                        <!-- Force Retest All Streams Sub-option -->
                        <div class="mt-2 ms-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="forceRetestOldStreams" disabled>
                                <label class="form-check-label" for="forceRetestOldStreams">
                                    <i class="fas fa-redo"></i> Force retest of ALL streams (even with recent stats)
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-exclamation-triangle text-warning"></i> <strong>Warning:</strong> This will test ALL streams, even those with recent stats. Only use if you need to refresh all statistics.
                            </small>
                            <div class="mt-2" id="retestThresholdContainer">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> By default, only streams without stats or with stats older than 
                                    <input type="number" id="retestDaysThreshold" class="form-control form-control-sm d-inline-block" 
                                           style="width: 60px;" min="1" value="7" disabled>
                                    days will be tested.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <h6 class="border-bottom pb-2 mb-3">Search Filters</h6>

                    <!-- Regex Pattern -->
                    <div class="mb-3">
                        <label for="regexPattern" class="form-label">
                            Regex Pattern (stream name)
                            <small class="text-muted">Example: ^ESPN.*HD$</small>
                        </label>
                        <input type="text" class="form-control" id="regexPattern" placeholder="Regex pattern...">
                    </div>

                    <!-- M3U Account -->
                    <div class="mb-3">
                        <label for="m3uAccountIds" class="form-label">M3U Accounts</label>
                        <select class="form-select" id="m3uAccountIds" multiple size="3">
                            <option value="">All accounts...</option>
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple accounts. Leave empty for all accounts.</div>
                    </div>

                    <!-- Video Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Video Conditions</h6>

                    <!-- Bitrate -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bitrateOperator" class="form-label">Bitrate Operator</label>
                            <select class="form-select" id="bitrateOperator">
                                <option value="">No restriction...</option>
                                <option value=">">Greater than (>)</option>
                                <option value=">=">Greater or equal (>=)</option>
                                <option value="<">Less than (<)</option>
                                <option value="<=">Less or equal (<=)</option>
                                <option value="==">Equal (==)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bitrateValue" class="form-label">Bitrate Value (Kbps)</label>
                            <input type="number" class="form-control" id="bitrateValue" placeholder="Ex: 5000">
                        </div>
                    </div>

                    <!-- Video Codec -->
                    <div class="mb-3">
                        <label for="videoCodec" class="form-label">
                            Video Codec 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="videoCodec" multiple size="6">
                            <option value="h264">H.264</option>
                            <option value="h265">H.265 (HEVC)</option>
                            <option value="mpeg2">MPEG-2</option>
                            <option value="vp9">VP9</option>
                            <option value="av1">AV1</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Resolution -->
                    <div class="mb-3">
                        <label for="resolution" class="form-label">
                            Video Resolution 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="resolution" multiple size="4">
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                            <option value="2160p">2160p (4K)</option>
                            <option value="SD">SD (&lt; 720p)</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- FPS -->
                    <div class="mb-3">
                        <label for="videoFps" class="form-label">
                            FPS (Frames per second) 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="videoFps" multiple size="5">
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Audio Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Audio Conditions</h6>

                    <!-- Audio Codec -->
                    <div class="mb-3">
                        <label for="audioCodec" class="form-label">
                            Audio Codec 
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="audioCodec" multiple size="5">
                            <option value="aac">AAC</option>
                            <option value="ac3">AC3 (Dolby Digital)</option>
                            <option value="eac3">E-AC3 (Dolby Digital Plus)</option>
                            <option value="mp3">MP3</option>
                            <option value="opus">Opus</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="previewRuleFromForm()">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for bulk creating rules -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Create Auto-Assignment Rules</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Bulk Rule Creation:</strong> Create auto-assignment rules automatically for all channels in a group.
                    Each rule will be generated with a regex pattern that matches streams containing all words from the channel name.
                </div>

                <form id="bulkCreateForm">
                    <!-- Group Selection -->
                    <div class="mb-3">
                        <label for="bulkGroupId" class="form-label">Channel Group *</label>
                        <select class="form-select" id="bulkGroupId" required>
                            <option value="">Select a group...</option>
                            <!-- Groups will be loaded dynamically -->
                        </select>
                        <small class="form-text text-muted">Select the channel group for which to create rules</small>
                    </div>

                    <!-- Creation Options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bulkSkipExisting" checked>
                            <label class="form-check-label" for="bulkSkipExisting">
                                <i class="fas fa-filter"></i> Only create rules for channels without existing rules
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            If checked, only channels that don't have auto-assignment rules will get new rules.
                            If unchecked, existing rules will be updated with the new conditions.
                        </small>
                    </div>

                    <!-- Status and Replace -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="bulkEnabled" checked>
                                <label class="form-check-label" for="bulkEnabled">
                                    Rules enabled by default
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="bulkReplaceExisting">
                                <label class="form-check-label" for="bulkReplaceExisting">
                                    Replace existing streams
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Test Streams Option -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bulkTestStreamsBeforeSorting">
                            <label class="form-check-label" for="bulkTestStreamsBeforeSorting">
                                <i class="fas fa-flask"></i> Test streams before assigning (obtains stats via ffmpeg)
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Only tests streams without stats or with outdated stats. Each stream will be started for 10 seconds to obtain stats (bitrate, codec, resolution, etc.).
                        </small>

                        <!-- Force Retest All Streams Sub-option -->
                        <div class="mt-2 ms-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bulkForceRetestOldStreams" disabled>
                                <label class="form-check-label" for="bulkForceRetestOldStreams">
                                    <i class="fas fa-redo"></i> Force retest of ALL streams (even with recent stats)
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-exclamation-triangle text-warning"></i> <strong>Warning:</strong> This will test ALL streams, even those with recent stats. Only use if you need to refresh all statistics.
                            </small>
                            <div class="mt-2" id="bulkRetestThresholdContainer">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> By default, only streams without stats or with stats older than
                                    <input type="number" id="bulkRetestDaysThreshold" class="form-control form-control-sm d-inline-block"
                                           style="width: 60px;" min="1" value="7" disabled>
                                    days will be tested.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <h6 class="border-bottom pb-2 mb-3">Search Filters</h6>

                    <!-- M3U Account -->
                    <div class="mb-3">
                        <label for="bulkM3uAccountIds" class="form-label">M3U Accounts</label>
                        <select class="form-select" id="bulkM3uAccountIds" multiple size="3">
                            <option value="">All accounts...</option>
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple accounts. Leave empty for all accounts.</div>
                    </div>

                    <!-- Video Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Video Conditions</h6>

                    <!-- Bitrate -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulkBitrateOperator" class="form-label">Bitrate Operator</label>
                            <select class="form-select" id="bulkBitrateOperator">
                                <option value="">No restriction...</option>
                                <option value=">">Greater than (>)</option>
                                <option value=">=">Greater or equal (>=)</option>
                                <option value="<">Less than (<)</option>
                                <option value="<=">Less or equal (<=)</option>
                                <option value="==">Equal (==)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulkBitrateValue" class="form-label">Bitrate Value (Kbps)</label>
                            <input type="number" class="form-control" id="bulkBitrateValue" placeholder="Ex: 5000">
                        </div>
                    </div>

                    <!-- Video Codec -->
                    <div class="mb-3">
                        <label for="bulkVideoCodec" class="form-label">
                            Video Codec
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkVideoCodec" multiple size="6">
                            <option value="h264">H.264</option>
                            <option value="h265">H.265 (HEVC)</option>
                            <option value="mpeg2">MPEG-2</option>
                            <option value="vp9">VP9</option>
                            <option value="av1">AV1</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Resolution -->
                    <div class="mb-3">
                        <label for="bulkResolution" class="form-label">
                            Video Resolution
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkResolution" multiple size="4">
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                            <option value="2160p">2160p (4K)</option>
                            <option value="SD">SD (&lt; 720p)</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- FPS -->
                    <div class="mb-3">
                        <label for="bulkVideoFps" class="form-label">
                            FPS (Frames per second)
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkVideoFps" multiple size="5">
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>

                    <!-- Audio Conditions -->
                    <h6 class="border-bottom pb-2 mb-3">Audio Conditions</h6>

                    <!-- Audio Codec -->
                    <div class="mb-3">
                        <label for="bulkAudioCodec" class="form-label">
                            Audio Codec
                            <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small>
                        </label>
                        <select class="form-select" id="bulkAudioCodec" multiple size="5">
                            <option value="aac">AAC</option>
                            <option value="ac3">AC3 (Dolby Digital)</option>
                            <option value="eac3">E-AC3 (Dolby Digital Plus)</option>
                            <option value="mp3">MP3</option>
                            <option value="opus">Opus</option>
                        </select>
                        <small class="form-text text-muted">Leave empty for no restriction</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createBulkRules()">
                    <i class="fas fa-magic"></i> Create Rules
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Matches Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Progress Modal -->
<div class="modal fade" id="executionProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> Executing Auto-Assignment Rule
                </h5>
            </div>
            <div class="modal-body">
                <!-- Progress bar -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted" id="progressLabel">Initializing...</span>
                        <span class="small text-muted" id="progressPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="executionProgressBar"
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- Log output -->
                <div class="card bg-dark text-light">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-terminal"></i> Execution Log</span>
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="clearExecutionLog()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                    <div class="card-body p-2" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                        <div id="executionLog"></div>
                    </div>
                </div>

                <!-- Summary (shown on completion) -->
                <div id="executionSummary" class="mt-3" style="display: none;">
                    <div class="alert" id="executionResult"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeProgressBtn" data-bs-dismiss="modal" disabled>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading indicator -->
<div id="loading" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Channel filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const channelFilter = document.getElementById('channelFilter');
    const rulesCount = document.getElementById('rulesCount');
    const ruleCards = document.querySelectorAll('[data-channel-name]');
    const totalRules = ruleCards.length;

    function updateRulesCount(visibleCount) {
        if (rulesCount) {
            rulesCount.textContent = `Showing ${visibleCount} of ${totalRules} rule${totalRules !== 1 ? 's' : ''}`;
        }
    }

    function filterRules() {
        const filterValue = channelFilter.value.toLowerCase().trim();
        let visibleCount = 0;
        
        ruleCards.forEach(card => {
            const channelName = card.dataset.channelName || '';
            const ruleNameElement = card.querySelector('.form-check-label');
            const ruleName = ruleNameElement ? ruleNameElement.textContent.toLowerCase() : '';
            const isVisible = !filterValue || 
                            channelName.includes(filterValue) || 
                            ruleName.includes(filterValue);
            
            card.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        updateRulesCount(visibleCount);
    }
    
    // Initial count
    updateRulesCount(totalRules);

    // Filter on input
    channelFilter.addEventListener('input', filterRules);
    
    // Clear filter function
    window.clearChannelFilter = function() {
        channelFilter.value = '';
        filterRules();
        channelFilter.focus();
    };
});
</script>
<script src="{{ url_for('static', filename='js/auto_assign_progress.js') }}"></script>
<script src="{{ url_for('static', filename='js/auto_assign.js') }}"></script>
{% endblock %}
